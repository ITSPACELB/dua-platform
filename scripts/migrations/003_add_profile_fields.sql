-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- ðŸ”„ Migration: Ø¥Ø¶Ø§ÙØ© Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- Ø§Ù„Ù‡Ø¯Ù: Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø¬Ø¯ÙˆÙ„ users
-- Ø§Ù„ØªØ§Ø±ÙŠØ®: 2025-10-15
-- Ø§Ù„Ù…Ø±Ø­Ù„Ø©: 5 - Menu & Profile Page
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

BEGIN;

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- ðŸ“ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø¬Ø¯ÙˆÙ„ users
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ALTER TABLE users 
  -- Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ (Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹ ØºØ§Ù„Ø¨Ø§Ù‹ØŒ Ù„ÙƒÙ† Ù†ØªØ£ÙƒØ¯)
  ADD COLUMN IF NOT EXISTS full_name VARCHAR(255),
  
  -- Ø§Ø³Ù… Ø§Ù„Ø£Ù… (Ù…Ø·Ù„ÙˆØ¨)
  ADD COLUMN IF NOT EXISTS mother_name VARCHAR(255),
  
  -- Ø§Ø³Ù… Ø§Ù„Ø£Ø¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
  ADD COLUMN IF NOT EXISTS father_name VARCHAR(255),
  
  -- Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
  ADD COLUMN IF NOT EXISTS email VARCHAR(255),
  
  -- Ø§Ù„Ø¹Ù…Ø± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
  ADD COLUMN IF NOT EXISTS age INTEGER,
  
  -- Ø§Ù„Ø¯ÙˆÙ„Ø© (ÙƒÙˆØ¯ Ø§Ù„Ø¯ÙˆÙ„Ø©ØŒ Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
  ADD COLUMN IF NOT EXISTS country VARCHAR(10),
  
  -- Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠØŒ Ø¨ØµÙŠØºØ© E.164)
  ADD COLUMN IF NOT EXISTS phone VARCHAR(20),
  
  -- ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ« Ù„Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ
  ADD COLUMN IF NOT EXISTS profile_updated_at TIMESTAMP;

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- ðŸ“Š Ø¥Ø¶Ø§ÙØ© Ù‚ÙŠÙˆØ¯ (Constraints)
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

-- Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙØ±ÙŠØ¯ (Ø¥Ø°Ø§ ØªÙ… Ø¥Ø¯Ø®Ø§Ù„Ù‡)
ALTER TABLE users
  ADD CONSTRAINT unique_email 
  UNIQUE (email);

-- Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ÙØ±ÙŠØ¯ (Ø¥Ø°Ø§ ØªÙ… Ø¥Ø¯Ø®Ø§Ù„Ù‡)
ALTER TABLE users
  ADD CONSTRAINT unique_phone 
  UNIQUE (phone);

-- Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø¹Ù…Ø± Ù…Ù†Ø·Ù‚ÙŠ
ALTER TABLE users
  ADD CONSTRAINT valid_age 
  CHECK (age IS NULL OR (age >= 1 AND age <= 120));

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- ðŸ” Ø¥Ø¶Ø§ÙØ© ÙÙ‡Ø§Ø±Ø³ (Indexes) Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

-- ÙÙ‡Ø±Ø³ Ù„Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ (Ù„Ù„Ø¨Ø­Ø« Ø§Ù„Ø³Ø±ÙŠØ¹)
CREATE INDEX IF NOT EXISTS idx_users_email 
  ON users(email) 
  WHERE email IS NOT NULL;

-- ÙÙ‡Ø±Ø³ Ù„Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ù„Ù„Ø¨Ø­Ø« Ø§Ù„Ø³Ø±ÙŠØ¹)
CREATE INDEX IF NOT EXISTS idx_users_phone 
  ON users(phone) 
  WHERE phone IS NOT NULL;

-- ÙÙ‡Ø±Ø³ Ù„Ù„Ø¯ÙˆÙ„Ø© (Ù„Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª)
CREATE INDEX IF NOT EXISTS idx_users_country 
  ON users(country) 
  WHERE country IS NOT NULL;

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- ðŸ“ ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© (Ù„Ù„ØªÙˆØ«ÙŠÙ‚)
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

COMMENT ON COLUMN users.full_name IS 'Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…';
COMMENT ON COLUMN users.mother_name IS 'Ø§Ø³Ù… Ø§Ù„Ø£Ù… (Ù…Ø·Ù„ÙˆØ¨ Ù„Ù„ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø´Ø±Ø¹ÙŠ)';
COMMENT ON COLUMN users.father_name IS 'Ø§Ø³Ù… Ø§Ù„Ø£Ø¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)';
COMMENT ON COLUMN users.email IS 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠØŒ ÙØ±ÙŠØ¯)';
COMMENT ON COLUMN users.age IS 'Ø¹Ù…Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø§Ø®ØªÙŠØ§Ø±ÙŠØŒ Ø¨ÙŠÙ† 1-120)';
COMMENT ON COLUMN users.country IS 'ÙƒÙˆØ¯ Ø§Ù„Ø¯ÙˆÙ„Ø© Ø­Ø³Ø¨ ISO (Ù…Ø«Ù„: SA, IQ, EG)';
COMMENT ON COLUMN users.phone IS 'Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø¨ØµÙŠØºØ© E.164 (Ù…Ø«Ù„: +9647XXXXXXXXX)';
COMMENT ON COLUMN users.profile_updated_at IS 'ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ« Ù„Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ';

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- ðŸ”„ Ø¯Ø§Ù„Ø©: ØªØ­Ø¯ÙŠØ« profile_updated_at ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

CREATE OR REPLACE FUNCTION update_profile_timestamp()
RETURNS TRIGGER AS $$
BEGIN
  -- ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆÙ‚Øª ÙÙ‚Ø· Ø¥Ø°Ø§ ØªØºÙŠØ±Øª Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø´Ø®ØµÙŠØ©
  IF (
    NEW.full_name IS DISTINCT FROM OLD.full_name OR
    NEW.mother_name IS DISTINCT FROM OLD.mother_name OR
    NEW.father_name IS DISTINCT FROM OLD.father_name OR
    NEW.email IS DISTINCT FROM OLD.email OR
    NEW.age IS DISTINCT FROM OLD.age OR
    NEW.country IS DISTINCT FROM OLD.country OR
    NEW.phone IS DISTINCT FROM OLD.phone
  ) THEN
    NEW.profile_updated_at = NOW();
  END IF;
  
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- âš¡ Trigger: ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¯Ø§Ù„Ø©
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

DROP TRIGGER IF EXISTS trigger_update_profile_timestamp ON users;

CREATE TRIGGER trigger_update_profile_timestamp
  BEFORE UPDATE ON users
  FOR EACH ROW
  EXECUTE FUNCTION update_profile_timestamp();

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- âœ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†Ø¬Ø§Ø­ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

DO $$
BEGIN
  -- Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
  IF EXISTS (
    SELECT 1 
    FROM information_schema.columns 
    WHERE table_name = 'users' 
      AND column_name IN ('mother_name', 'father_name', 'email', 'age', 'country', 'phone')
  ) THEN
    RAISE NOTICE 'âœ… Migration 003: ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ Ø¨Ù†Ø¬Ø§Ø­';
  ELSE
    RAISE EXCEPTION 'âŒ Migration 003: ÙØ´Ù„ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø¨Ø¹Ø¶ Ø§Ù„Ø­Ù‚ÙˆÙ„';
  END IF;
END $$;

COMMIT;

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- ðŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù„Ù„Ù…Ø·ÙˆØ±ÙŠÙ†
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- 1. Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ: ÙØ±ÙŠØ¯Ø§Ù† (UNIQUE)
-- 2. Ø§Ù„Ø¹Ù…Ø±: ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨ÙŠÙ† 1-120 Ø³Ù†Ø©
-- 3. Ø§Ù„Ø¯ÙˆÙ„Ø©: ÙŠÙØ®Ø²Ù† ÙƒÙƒÙˆØ¯ (SA, IQ, EG, Ø¥Ù„Ø®)
-- 4. Ø§Ù„Ù‡Ø§ØªÙ: ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨ØµÙŠØºØ© E.164 (+countrycode...)
-- 5. profile_updated_at: ÙŠØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø£ÙŠ ØªØºÙŠÙŠØ±
-- 6. Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ø®ØªÙŠØ§Ø±ÙŠØ© Ù…Ø§ Ø¹Ø¯Ø§ mother_name
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•